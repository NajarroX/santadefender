<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EL SANTA DEFENDER</title>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: monospace;
        }

        /* Estilo del Canvas */
        #gameCanvas {
            border: 4px solid #cc0000;
            background-color: #006600; /* Terreno de nieve/bosque (Verde Base) */
            touch-action: none; /* Previene el comportamiento por defecto del touch */
        }

        /* --- Controles Táctiles (Joystick) --- */
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            display: none; /* Inicialmente oculto, se muestra si es móvil */
        }

        .joystick-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .joystick-handle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            position: absolute;
            touch-action: none;
        }

        .action-button {
            position: absolute;
            bottom: 50px;
            right: 50px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #cc0000;
            border: 5px solid #fff;
            color: #fff;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div class="controls" id="mobileControls">
        <div class="joystick-container" id="joystickContainer">
            <div class="joystick-handle" id="joystickHandle"></div>
        </div>
    </div>
    <div class="action-button" id="shootButton">FUEGO</div>

    <script>
        // --- 1. CONFIGURACIÓN INICIAL Y DETECCIÓN ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width;
        const H = canvas.height;
        const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        // Referencias a los controles móviles
        const controls = document.getElementById('mobileControls');
        const shootButton = document.getElementById('shootButton');
        const joystickContainer = document.getElementById('joystickContainer');
        const joystickHandle = document.getElementById('joystickHandle');

        // Constantes del juego
        const PLAYER_SPEED = 4;
        const BULLET_SPEED = 8;
        const ENEMY_SPEED = 2;
        const JOYSTICK_RADIUS = 75; 

        // Mostrar/Ocultar controles según el dispositivo
        if (isMobile) {
            controls.style.display = 'block';
            shootButton.style.display = 'flex';
        } else {
            controls.style.display = 'none';
            shootButton.style.display = 'none';
        }

        // --- 2. OBJETOS DEL JUEGO ---

        let santa = {
            x: W / 2,
            y: H / 2,
            size: 20, 
            color: 'red',
            health: 10,
            dirX: 0,
            dirY: 0,
            shooting: false,
            lastShotTime: 0,
            fireRate: 200 
        };

        const tree = {
            x: W / 2,
            y: H / 2,
            size: 40,
            color: '#00aa00', 
            health: 50
        };

        let bullets = [];
        let enemies = [];
        let score = 0;
        
        // --- GLOBOS DE DIÁLOGO MEJORADOS ---
        const treeHealthMax = 50;
        const PHRASE_DURATION = 300; // 5 segundos a 60 FPS
        const PHRASE_INTERVAL = 8000; // 8 segundos
        
        let dialogue = {
            message: "¡Feliz Navidad, mis pequeños capitalistas!",
            duration: PHRASE_DURATION 
        };

        const sarcasticPhrases = [
            // >= 80% HP (40-50 HP)
            { min: 40, phrases: [
                "¡No me cansaré hasta que mis nietos hereden el negocio!", 
                "¡Este traje es de marca, no lo ensucies!", 
                "¡El valor de mercado de este pino es astronómico!",
                "¡Estos muchachos son peores que el tráfico en Black Friday!",
                "¡La codicia no los hace inmortales, chicos!"
            ] },
            // 50% - 80% HP (25-39 HP)
            { min: 25, phrases: [
                "¿De verdad? ¿Solo un arbolito? ¡Qué falta de ambición!", 
                "¡Un poco de dolor hará que aprecien más la Navidad.", 
                "¡Pagaría por un café con estos niveles de adrenalina!",
                "¡Mis elfos son más eficientes que esta fuerza de trabajo!",
                "¡Deberían estar invirtiendo en protección, no en deforestación!"
            ] },
            // < 50% HP (1-24 HP)
            { min: 1, phrases: [
                "¡Parece que vamos a necesitar un plan B... o un nuevo árbol!", 
                "¡Mi seguro de vida cubre esto, ¿verdad?!", 
                "¡Alguien va a pasar la Navidad en la lista negra!",
                "¡Si sobrevivo, subiré el precio de los juguetes en un 200%!",
                "¡Al menos es mejor que la reunión de la junta directiva de enero!"
            ] }
        ];

        let timeSinceLastPhrase = 0;


        // --- 3. MANEJO DE CONTROLES (PC: Teclado y Mouse) ---
        let keys = {};

        if (!isMobile) {
            window.addEventListener('keydown', (e) => {
                keys[e.code] = true;
            });

            window.addEventListener('keyup', (e) => {
                keys[e.code] = false;
                if (e.code === 'Space') {
                    santa.shooting = false;
                }
            });

            window.addEventListener('mousedown', (e) => {
                if (e.button === 0) santa.shooting = true; 
            });

            window.addEventListener('mouseup', (e) => {
                if (e.button === 0) santa.shooting = false;
            });
        }

        // --- 4. MANEJO DE CONTROLES (MÓVIL: Joystick Táctil) ---

        let joystickActive = false;
        let startX, startY;

        if (isMobile) {
            // Joystick Movement
            joystickContainer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
            });

            joystickContainer.addEventListener('touchmove', (e) => {
                if (!joystickActive) return;
                const touch = e.touches[0];
                
                let deltaX = touch.clientX - startX;
                let deltaY = touch.clientY - startY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > JOYSTICK_RADIUS) {
                    deltaX = (deltaX / distance) * JOYSTICK_RADIUS;
                    deltaY = (deltaY / distance) * JOYSTICK_RADIUS;
                }

                joystickHandle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

                santa.dirX = deltaX / JOYSTICK_RADIUS;
                santa.dirY = deltaY / JOYSTICK_RADIUS;
            });

            const resetJoystick = () => {
                joystickActive = false;
                santa.dirX = 0;
                santa.dirY = 0;
                joystickHandle.style.transform = `translate(0px, 0px)`;
            };

            joystickContainer.addEventListener('touchend', resetJoystick);
            joystickContainer.addEventListener('touchcancel', resetJoystick);

            // Shoot Button
            shootButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                santa.shooting = true;
            });
            shootButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                santa.shooting = false;
            });
        }


        // --- 5. LÓGICA DEL JUEGO (UPDATE) ---

        function updatePlayerMovement() {
            if (!isMobile) {
                // Lógica de PC (Teclado)
                santa.dirX = 0;
                santa.dirY = 0;

                if (keys['KeyA'] || keys['ArrowLeft']) santa.dirX = -1;
                if (keys['KeyD'] || keys['ArrowRight']) santa.dirX = 1;
                if (keys['KeyW'] || keys['ArrowUp']) santa.dirY = -1;
                if (keys['KeyS'] || keys['ArrowDown']) santa.dirY = 1;
            }
            
            const magnitude = Math.sqrt(santa.dirX * santa.dirX + santa.dirY * santa.dirY);
            if (magnitude > 0) {
                const nx = santa.dirX / magnitude;
                const ny = santa.dirY / magnitude;
                
                santa.x += nx * PLAYER_SPEED;
                santa.y += ny * PLAYER_SPEED;

                santa.x = Math.max(santa.size / 2, Math.min(W - santa.size / 2, santa.x));
                santa.y = Math.max(santa.size / 2, Math.min(H - santa.size / 2, santa.y));
            }
        }

        function handleShooting(deltaTime) {
            if ((!isMobile && (keys['Space'] || santa.shooting)) || (isMobile && santa.shooting)) {
                const currentTime = Date.now();
                if (currentTime - santa.lastShotTime > santa.fireRate) {
                    
                    const dx = tree.x - santa.x;
                    const dy = tree.y - santa.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const nx = dx / dist;
                    const ny = dy / dist;

                    bullets.push({
                        x: santa.x,
                        y: santa.y,
                        size: 8,
                        color: 'yellow',
                        dirX: nx,
                        dirY: ny
                    });
                    santa.lastShotTime = currentTime;
                }
            }
        }

        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.dirX * BULLET_SPEED;
                bullet.y += bullet.dirY * BULLET_SPEED;

                let hit = false;
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    if (checkCollision(bullet, enemy)) {
                        enemies.splice(j, 1); 
                        bullets.splice(i, 1); 
                        score += 10;
                        hit = true;
                        break;
                    }
                }

                if (!hit && (bullet.x < 0 || bullet.x > W || bullet.y < 0 || bullet.y > H)) {
                    bullets.splice(i, 1);
                }
            }
        }

        function spawnEnemies() {
            if (Math.random() < 0.02) { 
                const size = 15;
                const edge = Math.floor(Math.random() * 4); 
                let x, y;

                switch (edge) {
                    case 0: x = Math.random() * W; y = -size; break;
                    case 1: x = W + size; y = Math.random() * H; break;
                    case 2: x = Math.random() * W; y = H + size; break;
                    case 3: x = -size; y = Math.random() * H; break;
                }

                enemies.push({
                    x: x,
                    y: y,
                    size: size,
                    color: '#666666' 
                });
            }
        }

        function updateEnemies() {
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];

                const dx = tree.x - enemy.x;
                const dy = tree.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                const nx = dx / dist;
                const ny = dy / dist;

                enemy.x += nx * ENEMY_SPEED;
                enemy.y += ny * ENEMY_SPEED;

                if (checkCollision(enemy, tree)) {
                    tree.health -= 1;
                    enemies.splice(i, 1);
                    if (tree.health <= 0) {
                        alert('GAME OVER! El árbol ha sido talado. Puntuación: ' + score);
                        resetGame();
                        return;
                    }
                }
            }
        }
        
        function updateDialogue(deltaTime) {
            // El deltaTime está en milisegundos, debemos ajustarlo para PHRASE_DURATION (que está en frames)
            if (dialogue.duration > 0) {
                dialogue.duration -= (deltaTime / (1000 / 60)); // Asumiendo 60 FPS
            }

            timeSinceLastPhrase += deltaTime;
            if (timeSinceLastPhrase > PHRASE_INTERVAL && dialogue.duration <= 0) {
                
                let eligiblePhrases = [];
                
                for(const group of sarcasticPhrases) {
                    if (tree.health >= group.min) {
                        eligiblePhrases = group.phrases;
                        break;
                    }
                }
                
                if (eligiblePhrases.length > 0) {
                    const newPhrase = eligiblePhrases[Math.floor(Math.random() * eligiblePhrases.length)];
                    dialogue.message = newPhrase;
                    dialogue.duration = PHRASE_DURATION; 
                    timeSinceLastPhrase = 0;
                }
            }
        }


        function checkCollision(objA, objB) {
            return objA.x < objB.x + objB.size &&
                   objA.x + objA.size > objB.x &&
                   objA.y < objB.y + objB.size &&
                   objA.y + objA.size > objB.y;
        }

        function updateGame(deltaTime) {
            updatePlayerMovement();
            handleShooting(deltaTime);
            updateBullets();
            spawnEnemies();
            updateEnemies();
            updateDialogue(deltaTime); 
        }

        // --- 6. RENDERIZADO (DRAW) ---

        function drawRect(x, y, w, h, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x - w / 2, y - h / 2, w, h);
        }
        
        function drawCircle(x, y, r, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawTitle() {
            const titleText = "EL SANTA DEFENDER";
            const fontSize = 48; // Tamaño para un buen pixel art
            const titleColor = '#004d00'; // Verde oscuro, para contraste con #006600
            
            ctx.fillStyle = titleColor;
            ctx.font = `${fontSize}px monospace`;
            ctx.textAlign = 'center';
            
            // Simular un efecto de corte o bajo relieve
            // Dibuja el texto ligeramente desplazado para el efecto "cut-out"
            ctx.fillText(titleText, W / 2 + 2, H / 2 + fontSize * 1.5 + 2);
            ctx.fillText(titleText, W / 2 - 2, H / 2 + fontSize * 1.5 - 2);

            ctx.fillText(titleText, W / 2, H / 2 + fontSize * 1.5);
        }

        function drawTree() {
            // Tronco
            drawRect(tree.x, tree.y + tree.size / 2 - 5, 10, 10, '#8B4513');
            
            // Copa del árbol (Triángulo)
            ctx.fillStyle = tree.color;
            ctx.beginPath();
            ctx.moveTo(tree.x, tree.y - tree.size); 
            ctx.lineTo(tree.x - tree.size, tree.y + tree.size / 2);
            ctx.lineTo(tree.x + tree.size, tree.y + tree.size / 2);
            ctx.closePath();
            ctx.fill();

            // Bolitas Navideñas (Detalle)
            drawCircle(tree.x - 10, tree.y - 15, 3, 'yellow');
            drawCircle(tree.x + 15, tree.y, 3, 'red');
            drawCircle(tree.x - 5, tree.y + 10, 3, 'blue');

            // Dibujar salud del árbol
            ctx.fillStyle = 'white';
            ctx.font = '14px monospace';
            ctx.textAlign = 'center';
            ctx.fillText(`HP: ${tree.health}`, tree.x, tree.y + tree.size + 10);
        }

        function drawSanta() {
            // Cuerpo (Rojo)
            drawRect(santa.x, santa.y, santa.size, santa.size, santa.color);
            // Barba (Blanco)
            drawRect(santa.x, santa.y + 4, santa.size, santa.size / 2, 'white'); 
            // Sombrero 
            drawRect(santa.x, santa.y - 8, santa.size / 2, santa.size / 2, 'white'); // Pompón
            drawRect(santa.x, santa.y - 10, santa.size, santa.size / 3, santa.color); // Gorro
            
            // Ojos (Negro)
            drawRect(santa.x - 5, santa.y - 2, 3, 3, 'black');
            drawRect(santa.x + 5, santa.y - 2, 3, 3, 'black');
            
            // Dibujar Globo de Diálogo (si está activo)
            if (dialogue.duration > 0) {
                drawDialogueBubble(santa.x, santa.y, dialogue.message);
            }
        }
        
        function drawDialogueBubble(x, y, message) {
            const padding = 10;
            ctx.font = '16px monospace';
            const textMetrics = ctx.measureText(message);
            const textWidth = textMetrics.width;
            const textHeight = 16;
            
            const bubbleW = textWidth + padding * 2;
            const bubbleH = textHeight + padding * 2;
            const bubbleX = x - bubbleW / 2;
            const bubbleY = y - santa.size - bubbleH - 5; 
            
            // Dibujar el fondo del globo (blanco)
            ctx.fillStyle = 'white';
            ctx.fillRect(bubbleX, bubbleY, bubbleW, bubbleH);
            
            // Dibujar el texto (negro)
            ctx.fillStyle = 'black';
            ctx.textAlign = 'center';
            ctx.fillText(message, x, bubbleY + textHeight + padding - 2);
        }

        function drawEnemies() {
            enemies.forEach(e => {
                // Empresario (Gris con Maletín)
                drawRect(e.x, e.y, e.size, e.size, e.color);
                drawRect(e.x + e.size / 4, e.y + e.size / 4, e.size / 3, e.size / 3, 'black'); // Maletín
            });
        }

        function drawBullets() {
            bullets.forEach(b => {
                // Regalo (Amarillo/Dorado)
                drawRect(b.x, b.y, b.size, b.size, b.color);
            });
        }

        function drawHUD() {
            ctx.fillStyle = 'white';
            ctx.font = '20px monospace';
            ctx.textAlign = 'left';
            ctx.fillText(`Puntuación: ${score}`, 10, 30);
            ctx.textAlign = 'right';
            ctx.fillText(`Salud Santa: ${santa.health}`, W - 10, 30);
            
            if (isMobile) {
                 ctx.textAlign = 'center';
                 ctx.fillText(`Modo Móvil`, W / 2, 30);
            } else {
                 ctx.textAlign = 'center';
                 ctx.fillText(`Modo PC (WASD/Click)`, W / 2, 30);
            }
        }

        function drawGame() {
            // 1. Limpiar el Canvas
            ctx.clearRect(0, 0, W, H);
            
            // 2. Dibujar el Título (debajo de todo)
            drawTitle();

            // 3. Dibujar Objetos del Juego
            drawTree();
            drawEnemies();
            drawBullets();
            drawSanta();

            // 4. Dibujar HUD
            drawHUD();
        }

        // --- 7. BUCLE PRINCIPAL Y RESET ---

        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            updateGame(deltaTime); 
            drawGame();

            requestAnimationFrame(gameLoop);
        }

        function resetGame() {
            santa.x = W / 2;
            santa.y = H / 2;
            tree.health = treeHealthMax; 
            score = 0;
            enemies = [];
            bullets = [];
            dialogue.message = "¡Feliz Navidad, mis pequeños capitalistas!";
            dialogue.duration = PHRASE_DURATION;
            timeSinceLastPhrase = 0;
        }

        // Iniciar el juego
        resetGame();
        requestAnimationFrame(gameLoop);

    </script>
</body>
</html>
