<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Santa's Last Stand - Prototype</title>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: monospace;
        }

        /* Estilo del Canvas */
        #gameCanvas {
            border: 4px solid #cc0000;
            background-color: #006600; /* Terreno de nieve/bosque */
            touch-action: none; /* Previene el comportamiento por defecto del touch */
        }

        /* --- Controles Táctiles (Joystick) --- */
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            display: none; /* Inicialmente oculto, se muestra si es móvil */
        }

        .joystick-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .joystick-handle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.7);
            position: absolute;
            touch-action: none;
        }

        .action-button {
            position: absolute;
            bottom: 50px;
            right: 50px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #cc0000;
            border: 5px solid #fff;
            color: #fff;
            font-size: 1.5em;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <div class="controls" id="mobileControls">
        <div class="joystick-container" id="joystickContainer">
            <div class="joystick-handle" id="joystickHandle"></div>
        </div>
    </div>
    <div class="action-button" id="shootButton">FUEGO</div>

    <script>
        // --- 1. CONFIGURACIÓN INICIAL Y DETECCIÓN ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width;
        const H = canvas.height;
        const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        // Referencias a los controles móviles
        const controls = document.getElementById('mobileControls');
        const shootButton = document.getElementById('shootButton');
        const joystickContainer = document.getElementById('joystickContainer');
        const joystickHandle = document.getElementById('joystickHandle');

        // Constantes del juego
        const PLAYER_SPEED = 4;
        const BULLET_SPEED = 8;
        const ENEMY_SPEED = 2;
        const JOYSTICK_RADIUS = 75; // Mitad del tamaño del contenedor

        // Mostrar/Ocultar controles según el dispositivo
        if (isMobile) {
            controls.style.display = 'block';
            shootButton.style.display = 'flex';
        } else {
            controls.style.display = 'none';
            shootButton.style.display = 'none';
        }

        // --- 2. OBJETOS DEL JUEGO ---

        // Santa (el Jugador)
        let santa = {
            x: W / 2,
            y: H / 2,
            size: 20, // Pixel art minimalista
            color: 'red',
            health: 10,
            dirX: 0,
            dirY: 0,
            shooting: false,
            lastShotTime: 0,
            fireRate: 200 // Disparo cada 200ms
        };

        // El Árbol (Objetivo a defender)
        const tree = {
            x: W / 2,
            y: H / 2,
            size: 40,
            color: '#00aa00', // Verde oscuro
            health: 50
        };

        // Balas (Regalos)
        let bullets = [];

        // Enemigos (Empresarios Monstruosos)
        let enemies = [];
        let score = 0;

        // --- 3. MANEJO DE CONTROLES (PC: Teclado) ---
        let keys = {};

        if (!isMobile) {
            window.addEventListener('keydown', (e) => {
                keys[e.code] = true;
            });

            window.addEventListener('keyup', (e) => {
                keys[e.code] = false;
                if (e.code === 'Space') {
                    santa.shooting = false;
                }
            });

            window.addEventListener('mousedown', (e) => {
                if (e.button === 0) santa.shooting = true; // Botón izquierdo del mouse
            });

            window.addEventListener('mouseup', (e) => {
                if (e.button === 0) santa.shooting = false;
            });
        }

        // --- 4. MANEJO DE CONTROLES (MÓVIL: Joystick Táctil) ---

        let joystickActive = false;
        let startX, startY;

        if (isMobile) {
            // Joystick Movement
            joystickContainer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
            });

            joystickContainer.addEventListener('touchmove', (e) => {
                if (!joystickActive) return;
                const touch = e.touches[0];
                
                // Cálculo del vector de movimiento
                let deltaX = touch.clientX - startX;
                let deltaY = touch.clientY - startY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                // Normalizar y limitar al radio del joystick
                if (distance > JOYSTICK_RADIUS) {
                    deltaX = (deltaX / distance) * JOYSTICK_RADIUS;
                    deltaY = (deltaY / distance) * JOYSTICK_RADIUS;
                }

                // Mover el handle visualmente
                joystickHandle.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

                // Asignar dirección al Santa (normalizado de 0 a 1)
                santa.dirX = deltaX / JOYSTICK_RADIUS;
                santa.dirY = deltaY / JOYSTICK_RADIUS;
            });

            const resetJoystick = () => {
                joystickActive = false;
                santa.dirX = 0;
                santa.dirY = 0;
                joystickHandle.style.transform = `translate(0px, 0px)`;
            };

            joystickContainer.addEventListener('touchend', resetJoystick);
            joystickContainer.addEventListener('touchcancel', resetJoystick);

            // Shoot Button
            shootButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                santa.shooting = true;
            });
            shootButton.addEventListener('touchend', (e) => {
                e.preventDefault();
                santa.shooting = false;
            });
        }


        // --- 5. LÓGICA DEL JUEGO (UPDATE) ---

        function updatePlayerMovement() {
            if (!isMobile) {
                // Lógica de PC (Teclado)
                santa.dirX = 0;
                santa.dirY = 0;

                if (keys['KeyA'] || keys['ArrowLeft']) santa.dirX = -1;
                if (keys['KeyD'] || keys['ArrowRight']) santa.dirX = 1;
                if (keys['KeyW'] || keys['ArrowUp']) santa.dirY = -1;
                if (keys['KeyS'] || keys['ArrowDown']) santa.dirY = 1;
            }
            
            // Normalizar el vector de movimiento (para evitar velocidad doble en diagonal)
            const magnitude = Math.sqrt(santa.dirX * santa.dirX + santa.dirY * santa.dirY);
            if (magnitude > 0) {
                const nx = santa.dirX / magnitude;
                const ny = santa.dirY / magnitude;
                
                santa.x += nx * PLAYER_SPEED;
                santa.y += ny * PLAYER_SPEED;

                // Limitar al borde del canvas
                santa.x = Math.max(santa.size / 2, Math.min(W - santa.size / 2, santa.x));
                santa.y = Math.max(santa.size / 2, Math.min(H - santa.size / 2, santa.y));
            }
        }

        function handleShooting(deltaTime) {
            if ((!isMobile && (keys['Space'] || santa.shooting)) || (isMobile && santa.shooting)) {
                const currentTime = Date.now();
                if (currentTime - santa.lastShotTime > santa.fireRate) {
                    // Crea una bala de regalo (la dirección es siempre hacia el árbol en este prototipo simple)
                    
                    // Cálculo de la dirección hacia el árbol
                    const dx = tree.x - santa.x;
                    const dy = tree.y - santa.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    const nx = dx / dist;
                    const ny = dy / dist;

                    bullets.push({
                        x: santa.x,
                        y: santa.y,
                        size: 8,
                        color: 'yellow',
                        dirX: nx,
                        dirY: ny
                    });
                    santa.lastShotTime = currentTime;
                }
            }
        }

        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.dirX * BULLET_SPEED;
                bullet.y += bullet.dirY * BULLET_SPEED;

                // Chequeo de colisión con enemigos
                let hit = false;
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    if (checkCollision(bullet, enemy)) {
                        enemies.splice(j, 1); // Elimina al enemigo
                        bullets.splice(i, 1); // Elimina la bala
                        score += 10;
                        hit = true;
                        break;
                    }
                }

                // Eliminar bala si sale de la pantalla
                if (!hit && (bullet.x < 0 || bullet.x > W || bullet.y < 0 || bullet.y > H)) {
                    bullets.splice(i, 1);
                }
            }
        }

        function spawnEnemies() {
            if (Math.random() < 0.02) { // Probabilidad de spawn (ajustar dificultad aquí)
                const size = 15;
                const edge = Math.floor(Math.random() * 4); // 0=Top, 1=Right, 2=Bottom, 3=Left
                let x, y;

                switch (edge) {
                    case 0: // Top
                        x = Math.random() * W;
                        y = -size;
                        break;
                    case 1: // Right
                        x = W + size;
                        y = Math.random() * H;
                        break;
                    case 2: // Bottom
                        x = Math.random() * W;
                        y = H + size;
                        break;
                    case 3: // Left
                        x = -size;
                        y = Math.random() * H;
                        break;
                }

                enemies.push({
                    x: x,
                    y: y,
                    size: size,
                    color: '#666666' // Gris corporativo
                });
            }
        }

        function updateEnemies() {
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];

                // Dirigir al enemigo hacia el árbol
                const dx = tree.x - enemy.x;
                const dy = tree.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                const nx = dx / dist;
                const ny = dy / dist;

                enemy.x += nx * ENEMY_SPEED;
                enemy.y += ny * ENEMY_SPEED;

                // Colisión con el árbol
                if (checkCollision(enemy, tree)) {
                    tree.health -= 1;
                    enemies.splice(i, 1);
                    if (tree.health <= 0) {
                        alert('Game Over! El árbol ha sido talado. Puntuación: ' + score);
                        resetGame();
                        return;
                    }
                }
            }
        }

        // Función de colisión (caja delimitadora simple)
        function checkCollision(objA, objB) {
            return objA.x < objB.x + objB.size &&
                   objA.x + objA.size > objB.x &&
                   objA.y < objB.y + objB.size &&
                   objA.y + objA.size > objB.y;
        }

        function updateGame(deltaTime) {
            updatePlayerMovement();
            handleShooting(deltaTime);
            updateBullets();
            spawnEnemies();
            updateEnemies();
        }

        // --- 6. RENDERIZADO (DRAW) ---

        function drawRect(x, y, w, h, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x - w / 2, y - h / 2, w, h);
        }

        function drawTree() {
            // Tronco (Pixel art minimalista)
            drawRect(tree.x, tree.y + tree.size / 2 - 5, 10, 10, '#8B4513');
            // Copa del árbol (Triángulo)
            ctx.fillStyle = tree.color;
            ctx.beginPath();
            ctx.moveTo(tree.x, tree.y - tree.size / 2); // Punta
            ctx.lineTo(tree.x - tree.size, tree.y + tree.size / 2);
            ctx.lineTo(tree.x + tree.size, tree.y + tree.size / 2);
            ctx.closePath();
            ctx.fill();

            // Dibujar salud del árbol
            ctx.fillStyle = 'white';
            ctx.font = '14px monospace';
            ctx.textAlign = 'center';
            ctx.fillText(`HP: ${tree.health}`, tree.x, tree.y + tree.size + 10);
        }

        function drawSanta() {
            // Cuerpo (Rojo)
            drawRect(santa.x, santa.y, santa.size, santa.size, santa.color);
            // Barba (Blanco - para identificarlo)
            drawRect(santa.x, santa.y + 4, santa.size, santa.size / 3, 'white'); 
            // Sombrero (Blanco/Rojo)
            drawRect(santa.x, santa.y - 8, santa.size / 2, santa.size / 2, 'white'); 
        }

        function drawEnemies() {
            enemies.forEach(e => {
                // Empresario (Gris con Maletín)
                drawRect(e.x, e.y, e.size, e.size, e.color);
                drawRect(e.x + e.size / 4, e.y + e.size / 4, e.size / 3, e.size / 3, 'black'); // Maletín
            });
        }

        function drawBullets() {
            bullets.forEach(b => {
                // Regalo (Amarillo/Dorado)
                drawRect(b.x, b.y, b.size, b.size, b.color);
            });
        }

        function drawHUD() {
            ctx.fillStyle = 'white';
            ctx.font = '20px monospace';
            ctx.textAlign = 'left';
            ctx.fillText(`Puntuación: ${score}`, 10, 30);
            ctx.textAlign = 'right';
            ctx.fillText(`Salud: ${santa.health}`, W - 10, 30);
            
            if (isMobile) {
                 ctx.textAlign = 'center';
                 ctx.fillText(`Modo Móvil`, W / 2, 30);
            } else {
                 ctx.textAlign = 'center';
                 ctx.fillText(`Modo PC (WASD/Click)`, W / 2, 30);
            }
        }

        function drawGame() {
            // 1. Limpiar el Canvas
            ctx.clearRect(0, 0, W, H);
            
            // 2. Dibujar Objetos del Juego
            drawTree();
            drawEnemies();
            drawBullets();
            drawSanta();

            // 3. Dibujar HUD
            drawHUD();
        }

        // --- 7. BUCLE PRINCIPAL Y RESET ---

        let lastTime = 0;
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;

            updateGame(deltaTime);
            drawGame();

            requestAnimationFrame(gameLoop);
        }

        function resetGame() {
            // Reiniciar variables para un nuevo juego
            santa.x = W / 2;
            santa.y = H / 2;
            tree.health = 50;
            score = 0;
            enemies = [];
            bullets = [];
        }

        // Iniciar el juego
        resetGame();
        requestAnimationFrame(gameLoop);

    </script>
</body>
</html>
